<div class="admin-container">
    <div class="card admin-card">
        <div class="admin-header">
            <div class="header-left">
                <h1><i class="fas fa-cogs"></i> Админ-панель</h1>
                <p class="admin-subtitle">Управление пользователями системы</p>
            </div>
            <div class="header-actions">
                <a href="/profile" class="btn btn-primary">
                    <i class="fas fa-user"></i> Мой профиль
                </a>
                <a href="/logout" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> Выйти
                </a>
            </div>
        </div>
        
        <div class="admin-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3><%= locals.users ? locals.users.length : 0 %></h3>
                    <p>Всего пользователей</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="stat-info">
                    <h3><%= locals.users ? locals.users.filter(u => u.role === 'Админ').length : 0 %></h3>
                    <p>Администраторов</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-user-check"></i>
                </div>
                <div class="stat-info">
                    <h3><%= locals.users ? locals.users.filter(u => u.role === 'Пользователь').length : 0 %></h3>
                    <p>Обычных пользователей</p>
                </div>
            </div>
        </div>
        
        <div class="admin-content">
            <div class="content-header">
                <h2><i class="fas fa-list"></i> Список пользователей</h2>
                <button class="btn btn-success" onclick="refreshUsers()">
                    <i class="fas fa-sync-alt"></i> Обновить
                </button>
            </div>
            
            <% if (locals.users && locals.users.length > 0) { %>
                <div class="table-responsive">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Имя</th>
                                <th>Email (логин)</th>
                                <th>Роль</th>
                                <th>Дата регистрации</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% locals.users.forEach(user => { %>
                                <tr>
                                    <td><%= user.id %></td>
                                    <td><%= user.name %></td>
                                    <td><%= user.email %></td>
                                    <td>
                                        <span class="role-badge role-<%= user.role === 'Админ' ? 'admin' : 'user' %>">
                                            <%= user.role %>
                                        </span>
                                    </td>
                                    <td><%= new Date(user.createdAt).toLocaleDateString('ru-RU') %></td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-action btn-edit" onclick="editUser('<%= user.id %>')" title="Изменить роль">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <% if (user.role !== 'Админ') { %>
                                                <button class="btn-action btn-delete" onclick="deleteUser('<%= user.id %>')" title="Удалить">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            <% } %>
                                        </div>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            <% } else { %>
                <div class="empty-state">
                    <i class="fas fa-users-slash"></i>
                    <p>Нет зарегистрированных пользователей</p>
                </div>
            <% } %>
        </div>
        
        <div class="admin-footer">
            <p>Текущее время: <span id="current-time"></span></p>
            <p>Админ-панель v1.0</p>
        </div>
    </div>
</div>

<script>
// Обновление текущего времени
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('ru-RU');
    document.getElementById('current-time').textContent = timeString;
}

setInterval(updateTime, 1000);
updateTime();

// Функции управления пользователями
async function deleteUser(userId) {
    if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/users/${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Пользователь успешно удален');
            location.reload();
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка удаления:', error);
        alert('Ошибка удаления пользователя');
    }
}

async function editUser(userId) {
    try {
        // Загружаем список ролей
        const rolesResponse = await fetch('/api/roles');
        const roles = await rolesResponse.json();
        
        // Создаем модальное окно для изменения роли
        const modalHtml = `
            <div class="modal-overlay" id="editModal">
                <div class="modal-content">
                    <h3>Изменение роли пользователя</h3>
                    <select id="roleSelect" class="modal-select">
                        ${roles.map(role => `<option value="${role.id}">${role.name}</option>`).join('')}
                    </select>
                    <div class="modal-actions">
                        <button onclick="saveRole(${userId})" class="btn btn-primary">Сохранить</button>
                        <button onclick="closeModal()" class="btn btn-secondary">Отмена</button>
                    </div>
                </div>
            </div>
        `;
        
        // Добавляем модальное окно на страницу
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);
    } catch (error) {
        console.error('Ошибка загрузки ролей:', error);
        alert('Ошибка загрузки списка ролей');
    }
}

async function saveRole(userId) {
    const roleSelect = document.getElementById('roleSelect');
    const roleId = roleSelect.value;
    
    try {
        const response = await fetch(`/api/users/${userId}/role`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ roleId: parseInt(roleId) })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Роль успешно изменена');
            closeModal();
            location.reload();
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    } catch (error) {
        console.error('Ошибка изменения роли:', error);
        alert('Ошибка изменения роли');
    }
}

function closeModal() {
    const modal = document.getElementById('editModal');
    if (modal) {
        modal.parentNode.remove();
    }
}

function refreshUsers() {
    location.reload();
}

// Закрытие модального окна при клике вне его
document.addEventListener('click', function(event) {
    const modal = document.getElementById('editModal');
    if (modal && event.target === modal) {
        closeModal();
    }
});
</script>

